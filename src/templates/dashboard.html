<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      .time {
        font-weight: bold;
        color: #2d3e50;
        letter-spacing: 1px;
      }
      ul.route-list {
        margin: 0 0 0 10px;
        padding: 0 0 0 15px;
      }
    </style>
</head>
<body>
  {% include '_header.html' %}
  {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="alert {% if category %}alert-{{ category }}{% endif %}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>✈️ Flight Booker</h2>
        </div>
        <ul>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/reservations">My Reservations</a></li>
            <li><a href="/logout" class="logout">Log Out</a></li>
        </ul>
    </div>

    <!-- Account icon at top right -->
    <div class="account-icon">
        <a href="/profile" title="Account">
            <i class="fa-solid fa-user-circle"></i>
        </a>
    </div>

    <div class="main-content">
        <div class="hero hero-visual">
            <div class="hero-bg" aria-hidden="true">
              <!-- Decorative hero image removed to match theme and sidebar color.
                   The visual accent is provided by CSS in dashboard.css (::after) so no
                   large image is loaded here. -->
            </div>
            <div class="hero-left">
                <h1>Welcome, {{ username }}!</h1>
                <p class="lead">Find great fares and manage your bookings — all in one place.</p>
                <div class="hero-actions">
                  <a href="{{ url_for('reservations') }}" class="card-btn primary">My Reservations</a>
                  <a href="#search-section" class="card-btn secondary">Explore</a>
                </div>
                
            </div>
        </div>
        <div class="dashboard-cards">
            <div class="card">
                <h3>Search Flights</h3>
                <p>Find and book flights easily.</p>
                <form id="search-section" method="post" class="dashboard-search-form">
                    <label for="origin">Origin:</label>
                    <input type="text" id="origin" name="origin" placeholder="Enter origin (e.g. DEL)" required>
                    <label for="destination">Destination:</label>
                    <input type="text" id="destination" name="destination" placeholder="Enter destination (e.g. BOM)" required>
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    <button type="submit" class="card-btn">Search</button>
                </form>
            </div>
            <div class="card">
        <h3>My Reservations</h3>
        <p>View and manage your bookings.</p>
        {% if recent_reservations %}
          <div class="mini-reservations">
            {% for r in recent_reservations %}
              <div class="mini-reservation">
                <div class="mini-res-left">
                  <strong>{{ AIRLINE_NAMES.get(r.airline_code, r.airline_code) }} ({{ r.airline_code }})</strong>
                  <div class="mini-route"><small>{{ r.dep_port }} → {{ r.arri_port }}</small></div>
                  <div class="mini-times">
                    {% if r.dep_time %}
                      <div>Dep: <span class="time">{{ r.dep_time.strftime('%Y-%m-%d %H:%M') }}</span></div>
                    {% endif %}
                    {% if r.arri_time %}
                      <div>Arr: <span class="time">{{ r.arri_time.strftime('%Y-%m-%d %H:%M') }}</span></div>
                    {% endif %}
                  </div>
                  <div class="mini-booked">Booked: {% if r.creation_date %}{{ r.creation_date.strftime('%Y-%m-%d %H:%M') }}{% else %}N/A{% endif %}</div>
                </div>
                <div class="mini-res-right">
                  {% if r.id %}
                    <form method="post" action="{{ url_for('cancel_reservation') }}" onsubmit="return confirm('Cancel this reservation?');">
                      <input type="hidden" name="reservation_id" value="{{ r.id }}">
                      <button type="submit" class="card-btn danger small">Cancel</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
          <a href="/reservations" class="card-btn">View all</a>
        {% else %}
          <a href="/reservations" class="card-btn">View</a>
        {% endif %}
            </div>
            <div class="card">
                <h3>Account</h3>
                <p>Update your profile and settings.</p>
                <a href="/profile" class="card-btn">Profile</a>
            </div>
        </div>

        {% if search_results %}
        <div class="search-results">
            <h2>Search Results</h2>
            {% for flight in search_results %}
              {% set segments = flight.itineraries[0].segments %}
              <div class="result-card">
                <p>
                  <strong>Airline:</strong>
                  {% set code = segments[0].carrierCode %}
                  {{ AIRLINE_NAMES.get(code, code) }} ({{ code }})<br>
                  <strong>From:</strong> {{ segments[0].departure.iataCode }}<br>
                  <strong>To:</strong> {{ segments[-1].arrival.iataCode }}<br>
                  <strong>Departure:</strong>
                  {{ segments[0].departure.at.split('T')[0] }} &nbsp;
                  <span class="time">{{ segments[0].departure.at.split('T')[1] }}</span><br>
                  <strong>Arrival:</strong>
                  {{ segments[-1].arrival.at.split('T')[0] }} &nbsp;
                  <span class="time">{{ segments[-1].arrival.at.split('T')[1] }}</span><br>
                  <strong>Stops:</strong>
                  {% if segments|length == 1 %}
                    Non-stop
                  {% else %}
                    {{ segments|length - 1 }} stop{{ 's' if segments|length > 2 else '' }}
                  {% endif %}<br>
                  <strong>Route:</strong>
                  <ul class="route-list">
                    {% for seg in segments %}
                      <li>
                        {{ AIRLINE_NAMES.get(seg.carrierCode, seg.carrierCode) }} ({{ seg.carrierCode }}) :
                        {{ seg.departure.iataCode }} ({{ seg.departure.at.split('T')[0] }} {{ seg.departure.at.split('T')[1] }})
                        →
                        {{ seg.arrival.iataCode }} ({{ seg.arrival.at.split('T')[0] }} {{ seg.arrival.at.split('T')[1] }})
                      </li>
                    {% endfor %}
                  </ul>
                  <strong>Price:</strong> {{ flight.price.total }} {{ flight.price.currency }}
                </p>
                <form method="get" action="{{ url_for('book_preview', flight_id=loop.index0) }}">
                  <input type="hidden" name="flight_data" value='{{ flight | tojson | safe }}'>
                  <button type="submit" class="card-btn">Book</button>
                </form>
              </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    </div>
      <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    </body>
</html>
